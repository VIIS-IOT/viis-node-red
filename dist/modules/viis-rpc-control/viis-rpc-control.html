<script type="text/html" data-template-name="viis-rpc-control">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-mqttBroker"><i class="fa fa-exchange"></i> MQTT Broker</label>
        <select id="node-input-mqttBroker">
            <option value="thingsboard">ThingsBoard</option>
            <option value="local">EMQX Local</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-configKeys"><i class="fa fa-cog"></i> Config Keys (JSON)</label>
        <textarea id="node-input-configKeys" placeholder='{"max_temp": "number", "power": "boolean"}'></textarea>
    </div>
</script>

<script type="text/html" data-help-name="viis-rpc-control">
    <p>A node to receive RPC control payloads via MQTT, map them to Modbus addresses, write to Modbus, verify by reading back, and publish the result via MQTT. It also supports configuration keys that bypass Modbus writes.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>RPC control payload received from MQTT (e.g., <code>{ "set_ph": 7.0 }</code> or <code>{"method":"set_state","params":{"max_temp":40}}</code>).</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Telemetry data with timestamp sent to MQTT (e.g., <code>{ "ts": 1630000000000, "set_ph": 7.0 }</code> or config data).</dd>
    </dl>
    <h3>Details</h3>
    <p>This node subscribes to an MQTT topic and processes RPC payloads. If the payload contains a <code>method</code> field (e.g., <code>set_state</code>) and <code>params</code> with keys listed in <code>Config Keys</code>, it treats them as configuration data, stores them in the global variable <code>configKeys</code>, and skips Modbus operations.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType("viis-rpc-control", {
        category: "function",
        color: "#a6bbcf",
        defaults: {
            name: { value: "" },
            mqttBroker: { value: "thingsboard", required: true },
            configKeys: { value: '{"max_temp": "number", "power": "boolean"}' } // Giá trị mặc định
        },
        inputs: 0,
        outputs: 1,
        icon: "../../icons/logo.png",
        label: function () {
            return this.name || "viis-rpc-control";
        },
        oneditprepare: function () {
            // Optional: Validate JSON input
            $("#node-input-configKeys").on("change", function () {
                try {
                    JSON.parse($(this).val());
                } catch (e) {
                    RED.notify("Invalid JSON in Config Keys: " + e.message, "error");
                }
            });
        }
    });
</script>