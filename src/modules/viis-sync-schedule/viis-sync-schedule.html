<!-- 
  Node-RED editor configuration for the VIIS Sync Schedule node
  This file defines how the node appears and is configured in the Node-RED editor
-->

<script type="text/javascript">
    RED.nodes.registerType('viis-sync-schedule', {
        category: 'VIIS',
        color: '#5B9BD5',
        defaults: {
            name: { value: "" },
            accessToken: { value: "", required: true },
            syncInterval: { value: 15, required: true, validate: RED.validators.number() },
            syncOnStartup: { value: true },
            showDetailedLogs: { value: false },
            maxRetries: { value: 3, validate: RED.validators.number() }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-sync",
        label: function() {
            return this.name || "VIIS Sync Schedule";
        },
        paletteLabel: "VIIS Sync Schedule",
        oneditprepare: function() {
            // Show/hide advanced options
            const showAdvancedOptions = function(show) {
                if (show) {
                    $("#node-advanced-options").show();
                    $("#node-show-advanced").html('<i class="fa fa-minus"></i> Hide Advanced Options');
                } else {
                    $("#node-advanced-options").hide();
                    $("#node-show-advanced").html('<i class="fa fa-plus"></i> Show Advanced Options');
                }
            };
            
            // Initial state - collapsed
            showAdvancedOptions(false);
            
            // Toggle on click
            $("#node-show-advanced").on("click", function() {
                const isVisible = $("#node-advanced-options").is(":visible");
                showAdvancedOptions(!isVisible);
            });
            
            // Show help text for sync interval
            $("#node-input-syncInterval").on("change", function() {
                const value = parseInt($(this).val());
                const helpText = $("#sync-interval-help");
                
                if (value === 0) {
                    helpText.text("Automatic sync is disabled. Use manual triggers only.");
                    helpText.show();
                } else if (value < 5) {
                    helpText.text("Warning: Short intervals may cause high system load.");
                    helpText.show();
                } else if (value > 60) {
                    helpText.text("Note: Long intervals mean less frequent updates from server.");
                    helpText.show();
                } else {
                    helpText.hide();
                }
            });
            
            // Trigger initial help text
            $("#node-input-syncInterval").trigger("change");
        }
    });
</script>

<script type="text/html" data-template-name="viis-sync-schedule">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-section-header">Device Configuration</div>
    <div class="form-row">
        <label for="node-input-accessToken"><i class="fa fa-key"></i> Access Token</label>
        <input type="text" id="node-input-accessToken" placeholder="Device Access Token">
    </div>
    
    <div class="form-section-header">Sync Configuration</div>
    <div class="form-row">
        <label for="node-input-syncInterval"><i class="fa fa-clock-o"></i> Sync Interval (minutes)</label>
        <input type="number" id="node-input-syncInterval" min="0" placeholder="15">
        <div class="form-tips" id="sync-interval-help" style="display:none;"></div>
    </div>
    <div class="form-row">
        <label for="node-input-syncOnStartup"><i class="fa fa-play"></i> Sync on Startup</label>
        <input type="checkbox" id="node-input-syncOnStartup" style="display:inline-block; width:auto; vertical-align:top;">
        <div class="form-tips">If checked, schedule data will be synced when the node is deployed or restarted.</div>
    </div>
    
    <div class="form-row">
        <a href="#" class="editor-button" id="node-show-advanced"><i class="fa fa-plus"></i> Show Advanced Options</a>
    </div>
    
    <div id="node-advanced-options" style="display:none;">
        <div class="form-section-header">Advanced Options</div>
        <div class="form-row">
            <label for="node-input-maxRetries"><i class="fa fa-repeat"></i> Max Retries</label>
            <input type="number" id="node-input-maxRetries" min="0" max="10" placeholder="3">
            <div class="form-tips">Maximum number of retry attempts for API calls.</div>
        </div>
        <div class="form-row">
            <label for="node-input-showDetailedLogs"><i class="fa fa-list"></i> Detailed Logs</label>
            <input type="checkbox" id="node-input-showDetailedLogs" style="display:inline-block; width:auto; vertical-align:top;">
            <div class="form-tips">Enable more detailed logging for debugging.</div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="viis-sync-schedule">
    <p>A node that synchronizes schedules and schedule plans between the local database and server.</p>
    
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Any input message will trigger a manual synchronization.</dd>
    </dl>
    
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">object</span></dt>
        <dd>Contains the result of the synchronization operation with the following properties:</dd>
        <dd>
            <ul>
                <li><code>status</code> - <span class="property-type">string</span>: 'success', 'error', or 'warning'</li>
                <li><code>message</code> - <span class="property-type">string</span>: Human-readable result message</li>
                <li><code>result</code> - <span class="property-type">object</span>: Detailed sync results (only on success)</li>
            </ul>
        </dd>
    </dl>
    
    <h3>Details</h3>
    <p>This node performs the following operations:</p>
    <ul>
        <li>Fetches schedule plans and schedules from the server</li>
        <li>Compares with local database records</li>
        <li>Updates local records if server data is newer or missing locally</li>
        <li>Marks local records as deleted if they no longer exist on the server</li>
        <li>Tracks sync status and history</li>
    </ul>
    
    <h3>Configuration</h3>
    <h4>Basic Settings</h4>
    <ul>
        <li><b>Name</b>: Customize the node name in the flow</li>
        <li><b>Access Token</b>: The device access token for authentication with the server</li>
        <li><b>Sync Interval</b>: How often to automatically sync (in minutes, 0 to disable)</li>
        <li><b>Sync on Startup</b>: Whether to perform a sync when the node is deployed</li>
    </ul>
    
    <h4>Advanced Settings</h4>
    <ul>
        <li><b>Max Retries</b>: Maximum number of retry attempts for API calls</li>
        <li><b>Detailed Logs</b>: Enable more detailed logging for debugging</li>
    </ul>
    
    <h3>Status Indicators</h3>
    <ul>
        <li><b>Green ring</b>: Node is ready for sync operations</li>
        <li><b>Blue dot</b>: Sync is in progress</li>
        <li><b>Green dot</b>: Sync completed successfully</li>
        <li><b>Red ring</b>: Sync failed</li>
    </ul>
</script>

<style>
    .form-section-header {
        padding: 8px 0;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
        margin-bottom: 10px;
        color: #555;
    }
</style>
