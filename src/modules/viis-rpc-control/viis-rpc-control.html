<script type="text/html" data-template-name="viis-rpc-control">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-mqttBroker"><i class="fa fa-exchange"></i> MQTT Broker</label>
        <select id="node-input-mqttBroker">
            <option value="thingsboard">ThingsBoard</option>
            <option value="local">EMQX Local</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-configKeys"><i class="fa fa-cog"></i> Config Keys</label>
        <textarea id="node-input-configKeys" style="width: 100%; min-height: 150px;" 
            placeholder='{"max_temp": "number", "power": "boolean", "mode": "string"}'></textarea>
    </div>
    <div class="form-row">
        <label for="node-input-scaleConfigs"><i class="fa fa-balance-scale"></i> Scale Configs</label>
        <textarea id="node-input-scaleConfigs" style="width: 100%; min-height: 150px;" 
            placeholder='[{"key": "set_ph", "operation": "multiply", "factor": 10}, {"key": "set_ec", "operation": "multiply", "factor": 1000}]'></textarea>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("viis-rpc-control", {
        category: "function",
        color: "#a6bbcf",
        defaults: {
            name: { value: "" },
            mqttBroker: { value: "thingsboard", required: true },
            configKeys: {
                value: '{"max_temp": "number", "power": "boolean"}',
                required: true,
                validate: function (v) {
                    try {
                        const parsed = JSON.parse(v);
                        return typeof parsed === 'object' && parsed !== null;
                    } catch (e) {
                        return false;
                    }
                }
            },
            scaleConfigs: {
                value: '[]',
                required: false,
                validate: function (v) {
                    try {
                        const parsed = JSON.parse(v);
                        return Array.isArray(parsed);
                    } catch (e) {
                        return false;
                    }
                }
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "../../icons/logo.png",
        label: function () {
            return this.name || "viis-rpc-control";
        },
        oneditprepare: function () {
            const that = this;

            // Format JSON in textareas
            ['configKeys', 'scaleConfigs'].forEach(function (field) {
                const element = $(`#node-input-${field}`);
                try {
                    const value = element.val();
                    if (value) {
                        const formatted = JSON.stringify(JSON.parse(value), null, 2);
                        element.val(formatted);
                    }
                } catch (e) {
                    console.log(`Error formatting ${field}:`, e);
                }

                // Add validation on change
                element.on("change", function () {
                    try {
                        const parsed = JSON.parse($(this).val());
                        const formatted = JSON.stringify(parsed, null, 2);
                        $(this).val(formatted);
                        RED.notify(`Valid ${field} JSON`, "success");
                    } catch (e) {
                        RED.notify(`Invalid ${field} JSON: ${e.message}`, "error");
                    }
                });
            });
        },
        oneditsave: function () {
            // Compact JSON before saving
            ['configKeys', 'scaleConfigs'].forEach(function (field) {
                const element = $(`#node-input-${field}`);
                try {
                    const value = element.val();
                    if (value) {
                        element.val(JSON.stringify(JSON.parse(value)));
                    }
                } catch (e) {
                    console.log(`Error compacting ${field}:`, e);
                }
            });
        }
    });
</script>